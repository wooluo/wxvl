#  【漏洞复现】Apache Tomcat 命令执行漏洞（CVE-2025-24813)  
稻草人  玄武盾网络技术实验室   2025-06-23 13:52  
  
**“**  
 对我们感兴趣的话就点个关注吧！**”**  
  
## 漏洞介绍  
  
**Apache Tomcat 命令执行漏洞（CVE-2025-24813)**  
  
Tomcat 作为一款开源的轻量级 Web 应用服务器与 Servlet 容器，由 Apache 软件基金会旗下 Jakarta 项目负责开发，是当下极为流行的 Java Web 服务器之一。  
  
**漏洞影响范围**  
- 9.0.0.M1 <= tomcat <= 9.0.98  
  
- 10.1.0-M1 <= tomcat <= 10.1.34  
  
- 11.0.0-M1 <= tomcat <= 11.0.2  
  
**漏洞原理分析**  
  
在 Tomcat 里，HTTP PUT 请求中的 Content-Range 头字段主要发挥着实现大文件分块传输的重要作用。当文件上传处于未完成状态时，这些上传内容会被临时存放在 Tomcat 工作目录中，具体位置是：$CATALINA_BASE/work/Catalina/localhost/ROOT  
。  
  
![upload5image-20250321211125092.png](https://mmbiz.qpic.cn/mmbiz_jpg/UM0M1icqlo0m7IMzmyBesqxANnoQ2gekwXJta5Wgcwc8rOdbaJspzy1fn1icxOFKNicrpNe02TQ0x5ABtUOzXMvyQ/640?wx_fmt=jpeg&from=appmsg "")  
  
    
该漏洞的核心在于不完整 PUT 请求上传时的文件名处理机制，其会将文件路径中的分隔符 /  
 转换为 .  
。例如，访问路径 /xxxxx/session  
 会被解析为 .xxxxx.session  
。因此，整个漏洞的利用过程为  
：  
1. Tomcat的File会话存储默认路径同样位于：CATALINA_BASE/work/Catalina/localhost/ROOT  
  
1. 当存在反序列化利用链时，可以上传包含恶意序列化数据的文件  
  
1. 通过设置JSESSIONID=.xxxxx  
来触发漏洞  
  
## 环境搭建  
  
该漏洞的利用条件较为苛刻，其核心成因是：当 Tomcat 处理不完整的 HTTP PUT 请求时，会依据用户提供的文件名及路径动态生成临时文件。若以下条件同时满足，攻击者即可执行任意代码：  
1. **默认 Servlet 启用了写权限（默认禁用）**  
  
1. **启用了部分PUT请求支持（默认启用）**  
  
1. **应用程序使用 Tomcat 的基于文件的会话持久化（默认存储位置）**  
  
1. **应用程序包含可被利用于反序列化攻击的库**  
  
下面就是需要下载和配置的设置  
  
复现版本Tomcat 9.0.98  
```
```  
  
**构造利用条件：**  
  
条件一、需要在conf/web.xml中，将DefaultServlet的readonly配置为false，启用写入功能  
```
```  
  
![upload5image-20250321205642707.png](https://mmbiz.qpic.cn/mmbiz_jpg/UM0M1icqlo0m7IMzmyBesqxANnoQ2gekwNBicicwzP79VwUAv8dICwtQTOHiaSXQRCzibUlWxTKyTb7FGjGvib8eNB3A/640?wx_fmt=jpeg&from=appmsg "")  
  
条件二、PUT方法默认开启  
  
条件三、在conf/context.xml中，开启File文件会话存储  
```
```  
  
![upload5image-20250321205736018.png](https://mmbiz.qpic.cn/mmbiz_jpg/UM0M1icqlo0m7IMzmyBesqxANnoQ2gekwDibE3GibA3icWIxxxvjzpfwwllC2xnlqjMdbLiaicoFjnNLXVvbdZNOeGPA/640?wx_fmt=jpeg&from=appmsg "")  
  
条件四、下载 commons-collections-3.2.1.jar, 把 jar 包放入webapps\ROOT\WEB-INF\lib  
目录下，如果没有这个目录就创建一个  
```
```  
  
![upload5image-20250321205923994.png](https://mmbiz.qpic.cn/mmbiz_jpg/UM0M1icqlo0m7IMzmyBesqxANnoQ2gekwnX61Bd5AibP7JK58amfPYBa6GqXa0gckyYkFICUEfLvYBLfKkYgwia1w/640?wx_fmt=jpeg&from=appmsg "")  
  
环境搭建好后就可点击bin目录下面的startup.bat  
启动环境。  
  
![upload5image-20250321232535464.png](https://mmbiz.qpic.cn/mmbiz_jpg/UM0M1icqlo0m7IMzmyBesqxANnoQ2gekwT3YBz5pdhv1DmgLsXrYLQXu2R9dicKbczHQpdiazlDicQZFCXGta2DRew/640?wx_fmt=jpeg&from=appmsg "")  
## 漏洞复现  
  
【Yso-Java Hack】模块生成一个利用payload：  
  
![upload5image-20250321174901535.png](https://mmbiz.qpic.cn/mmbiz_jpg/UM0M1icqlo0m7IMzmyBesqxANnoQ2gekwWNGHBfsLEQSjXkicXUbS7FHUjQq71dSeehAAfzG6qdGxpvia68nvTynQ/640?wx_fmt=jpeg&from=appmsg "")  
  
在使用该数据包进行上传时，请务必确保以下几点：  
  
1. **Range 头字段的分块值必须与 Content-Length 完全一致，**  
1. **Content-Length 的值需大于目标文件的当前长度，以此确保能覆盖原有内容。**  
```
```  
  
  
下面poc可触发  
```
```  
  
  
也能够上传 webshell，只需对执行命令进行修改即可。默认情况下，执行 cmd 的位置是 bin 目录，将 webshell 上传到该目录是没有用的，所以修改一下路径就行。其他诸如反弹 shell 等操作，原理都是一样的。  
  
  
要是写入失败，有可能是本地普通用户没有写入文件的权限，对权限进行设置后就可以成功写入了。  
```
```  
  
  
  
你上传的 JSP WebShell 确实已成功写入服务器，但由于 Tomcat 的安全机制限制，该文件可能被标记为不可执行或不可访问。  
  
![upload5image-20250322210814834.png](https://mmbiz.qpic.cn/mmbiz_jpg/UM0M1icqlo0m7IMzmyBesqxANnoQ2gekwNWX1uVoBZv5abggO5ibbUs7N0H3oDR7U47WHict0MILa6gfNeHKlsz8A/640?wx_fmt=jpeg&from=appmsg "")  
# 修复方案  
  
目前Apache官方已公布漏洞公告，可下载补丁更新：https://lists.apache.org/thread/j5fkjv2k477os90nczf2v9l61fb0kkgq  
  
领导说不点「推荐」就扣我鸡腿！救救孩子吧。  
  
![图片](https://mmbiz.qpic.cn/mmbiz_png/UM0M1icqlo0knIjq7rj7rsX0r4Rf2CDQylx0IjMfpPM93icE9AGx28bqwDRau5EkcWpK6WBAG5zGDS41wkfcvJiaA/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp "")  
  
声明：  
技术文章均收集于互联网，仅作为本人学习、记录使用。  
侵权删  
！  
！  
  
