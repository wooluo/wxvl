#  CVE-2025-1729 - 使用 TPQMAssistant.exe 进行权限提升  
 Ots安全   2025-07-18 02:34  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/bL2iaicTYdZn7gtxSFZlfuCW6AdQib8Q1onbR0U2h9icP1eRO6wH0AcyJmqZ7USD0uOYncCYIH7ZEE8IicAOPxyb9IA/640?wx_fmt=gif "")  
  
在深入研究我的新款联想 ThinkPad P1 Gen7 的内部结构时，我偶然发现了一个意外的现象，这个现象很快从好奇心升级为可行的权限提升漏洞。   
  
每天上午 9:30 分，执行名为：  
  
Lenovo\TrackPointQuickMenu\Schedule\ActivationDailyScheduleTask  
  
自动启动二进制文件：  
  
C:\ProgramData\Lenovo\TPQM\Assistant\TPQMAssistant.exe  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tafrMzIYYkSzsphGO3QCxd1P3ztTSOAoVTI1IhVe7wrCXP3UxpIMUWbiaODXOy7fKc83r4qRPib06Hsg/640?wx_fmt=webp&from=appmsg "")  
  
图 1 - 计划任务  
  
此任务仅在用户登录时运行，特别有趣的是，此二进制文件容易受到动态链接库（DLL）侧载的攻击 - 这是一种经典且经常被忽视的攻击媒介。  
  
可写目录和缺失的 DLL  
  
TPQMAssistant.exe所在的目录可由标准用户写入，这本身就是一个危险信号。该文件夹的权限允许创建者/所有者写入文件，这意味着任何本地用户都可以将文件拖放到此位置。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tafrMzIYYkSzsphGO3QCxd1Pua8G9XqZ2uich0xqQ1qFoZjUEjunhFyhFjLjf60hdfrLbkTtH05eXnQ/640?wx_fmt=webp&from=appmsg "")  
  
图 2 - 文件夹的创建者/所有者  
  
当计划任务（或二进制文件本身）被触发时，它会尝试从其工作目录加载 hostfxr.dll，但失败了，导致出现 NAME NOT FOUND 事件。这告诉我们该二进制文件正在寻找其自身目录中不存在的依赖项——这是侧载的绝佳机会。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tafrMzIYYkSzsphGO3QCxd1PkBGyQnlicws9o4UfMEficNsLZEFsP6hbslr7ibZ7dbzREqpU0A7DAdwzQ/640?wx_fmt=webp&from=appmsg "")  
  
图 3 - 未找到名称  
  
包含TPQMAssistant.exe的目录可由用户写入，从而允许将新文件添加到该文件夹。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tafrMzIYYkSzsphGO3QCxd1Pua8G9XqZ2uich0xqQ1qFoZjUEjunhFyhFjLjf60hdfrLbkTtH05eXnQ/640?wx_fmt=webp&from=appmsg "")  
  
图 4 - 文件夹的创建者所有者  
  
代码执行  
  
通过将恶意hostfxr.dll放置在与TPQMAssistant.exe相同的目录中，我们可以劫持加载进程。当二进制文件执行时，它会成功加载我们植入的 DLL 并运行我们的代码。在我的 PoC 代码中，我只是显示一个消息框来验证代码的执行情况。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tafrMzIYYkSzsphGO3QCxd1PpiaHwX7QZ8nAAVIsQrX7iaicMo9nSttTSnWmEz6544RRSLMfqeHxG2T4A/640?wx_fmt=webp&from=appmsg "")  
  
图 5 - 植入 DLL 的简单概念验证源代码  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tafrMzIYYkSzsphGO3QCxd1PL0rBRrJaI0uHsNOg30STuXR7FdYD5oIwJ7YCDVOvAT6w4oTMybKvcw/640?wx_fmt=webp&from=appmsg "")  
  
图 6-加载 DLL 的消息框  
  
从用户到管理员 - 计划权限提升  
  
虽然这本身就是一个稳固的立足点，但真正的权限提升发生在拥有管理员权限的用户登录时。由于计划任务每天上午 9:30 在登录用户的上下文中运行，我们的恶意 DLL 将在管理员会话中执行。虽然该进程将以中等完整性级别运行，但如果您想一路走下去，已经存在足够多的 UAC 绕过方法来实现权限提升。我决定就此打住，只是问了联想是否需要完整的 PoC 代码，因为我觉得自己已经证明了这个漏洞的存在。事实证明，这足以让他们开始修复它。攻击流程如下：以普通用户身份登录，植入恶意代码，注销，然后等待本地管理员使用该计算机执行代码。  
  
减轻  
  
联想产品安全事件响应团队 (PSIRT) 向我发送了一个修复程序，我已测试并验证了该程序的有效性。修复方法是从微软商店安装他们发布的 TrackPoint Quick Menu 1.12.54.0 版本。由于这是一个 UWP 应用程序，其数据存储在c:\program files\目录下，因此 1.12.54.0 版本解决了权限提升漏洞。UWP 版本可在此处找到：https://apps.microsoft.com/detail/9mz08jf4t3ng  
  
然而，这并没有删除现有的 Win32 版本的应用程序或计划任务，因此仍然容易受到攻击。在将此问题告知 PSIRT 后，他们做出了如下回应：  
  
预装 TPQM 的更新包将通过系统更新 (System Update) 提供，这是我们自动拉取应用程序、固件和驱动程序更新的机制。新更新包会将 TPQM 调度程序的标准安装路径从C:\ProgramData目录移至C:\Program Files (x86)\Lenovo\TPQM\TPQMAssistant。它还会检查该调度程序可执行文件是否已在C:\ProgramData路径下注册，如果已注册，则将删除该路径并卸载该调度程序，然后在C:\Program Files (x86)目录下为该调度程序创建新路径。  
  
基于此，一旦他们开始部署软件，问题似乎就会得到解决。  
  
最后的想法  
  
与 PSIRT 合作非常愉快——他们回复迅速，沟通礼貌且坦诚。在整个过程中，他们也及时向我发送了信息，无需我反复询问。我唯一的愿望是希望他们能给安全研究人员一些奖励，比如一些小礼品或奖金，这样或许能促使安全研究人员做出更多发现（我个人认为）。我确实收到了感谢状。  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tafrMzIYYkSzsphGO3QCxd1PiaQwlv8loK2jarhXPMTxdef3v20dIP4FIJlibXMGCrjdpr0YvSL4GEJg/640?wx_fmt=webp&from=appmsg "")  
  
图7-感谢状  
  
时间线  
  
2025 年 1 月 30 日 - 初步发现  
  
2025 年 1 月 31 日 - 向 PSIRT 发送第一封关于该发现的电子邮件  
  
2025 年 1 月 31 日 - 跟踪号和确认正在由开发团队审核2025 年  
  
2025 年   
2 月 18 日 - PSIRT 开发团队确认该问题并将进行修复  
  
2025 年 2 月 26 日 - 修复计划于 6 月 10 日进行的信息  
  
2025 年 6 月 22 日 - 有关修复部署延迟的信息；新日期设为  
  
2025 年   
6 月 30 日-  
 7 月 8 日  - 发送有关已发布 UWP 应用程序的邮件，可以对其进行测试以确认修复  
  
2025 年 7 月 1 日 - 发送电子邮件说明该问题在 UWP 中不存在，但不会从机器中删除现有问题  
  
2025 年 7 月 1 日 - PSIRT 回复说他们正在努力开发修复程序，将通过系统更新分发给已预装该软件版本的用户，该修复程序将删除计划任务和旧的可执行文件  
  
  
  
感谢您抽出  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycNnFvFYVgXoExRy0gqCkqvrAghf8KPXnwQaYq77HMsjcVka7kPcBDQw/640?wx_fmt=gif "")  
  
.  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycd5KMTutPwNWA97H5MPISWXLTXp0ibK5LXCBAXX388gY0ibXhWOxoEKBA/640?wx_fmt=gif "")  
  
.  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycU99fZEhvngeeAhFOvhTibttSplYbBpeeLZGgZt41El4icmrBibojkvLNw/640?wx_fmt=gif "")  
  
来阅读本文  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWge7Mibiad1tV0iaF8zSD5gzicbxDmfZCEL7vuOevN97CwUoUM5MLeKWibWlibSMwbpJ28lVg1yj1rQflyQ/640?wx_fmt=gif "")  
  
**点它，分享点赞在看都在这里**  
  
